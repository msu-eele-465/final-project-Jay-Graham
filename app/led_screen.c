#include <msp430.h>
#include "i2c_utils.h"
#include "led_screen.h"

#define LED_SCREEN_DEVICE_ID 0

static const char oled_init_cmds[] = {
    0x00, 0xAE, 0xD5, 0x80, 0xA8, 0x3F, 0xD3, 0x00,
    0x40, 0x8D, 0x14, 0x20, 0x00, 0xA1, 0xC8, 0xDA,
    0x12, 0x81, 0xCF, 0xD9, 0xF1, 0xDB, 0x40, 0xA4,
    0xA6, 0xAF
};

static const unsigned char font6x8[][6] = {
    [' '] = { 0x00,0x00,0x00,0x00,0x00,0x00 },
    ['A'] = { 0x7C,0x12,0x11,0x12,0x7C,0x00 },
    ['B'] = { 0x7F,0x49,0x49,0x49,0x36,0x00 },
    ['C'] = { 0x3E,0x41,0x41,0x41,0x22,0x00 },
    ['D'] = { 0x7F,0x41,0x41,0x22,0x1C,0x00 },
    ['E'] = { 0x7F,0x49,0x49,0x49,0x41,0x00 },
    ['F'] = { 0x7F,0x09,0x09,0x09,0x01,0x00 },
    ['G'] = { 0x3E,0x41,0x49,0x49,0x7A,0x00 },
    ['H'] = { 0x7F,0x08,0x08,0x08,0x7F,0x00 },
    ['I'] = { 0x00,0x41,0x7F,0x41,0x00,0x00 },
    ['J'] = { 0x20,0x40,0x41,0x3F,0x01,0x00 },
    ['K'] = { 0x7F,0x08,0x14,0x22,0x41,0x00 },
    ['L'] = { 0x7F,0x40,0x40,0x40,0x40,0x00 },
    ['M'] = { 0x7F,0x02,0x0C,0x02,0x7F,0x00 },
    ['N'] = { 0x7F,0x04,0x08,0x10,0x7F,0x00 },
    ['O'] = { 0x3E,0x41,0x41,0x41,0x3E,0x00 },
    ['P'] = { 0x7F,0x09,0x09,0x09,0x06,0x00 },
    ['Q'] = { 0x3E,0x41,0x51,0x21,0x5E,0x00 },
    ['R'] = { 0x7F,0x09,0x19,0x29,0x46,0x00 },
    ['S'] = { 0x46,0x49,0x49,0x49,0x31,0x00 },
    ['T'] = { 0x01,0x01,0x7F,0x01,0x01,0x00 },
    ['U'] = { 0x3F,0x40,0x40,0x40,0x3F,0x00 },
    ['V'] = { 0x1F,0x20,0x40,0x20,0x1F,0x00 },
    ['W'] = { 0x7F,0x20,0x18,0x20,0x7F,0x00 },
    ['X'] = { 0x63,0x14,0x08,0x14,0x63,0x00 },
    ['Y'] = { 0x07,0x08,0x70,0x08,0x07,0x00 },
    ['Z'] = { 0x61,0x51,0x49,0x45,0x43,0x00 },
    ['0'] = { 0x3E, 0x45, 0x49, 0x51, 0x3E, 0x00 },
    ['1'] = { 0x00, 0x42, 0x7F, 0x40, 0x00, 0x00 },
    ['2'] = { 0x62, 0x51, 0x49, 0x49, 0x46, 0x00 },
    ['3'] = { 0x22, 0x49, 0x49, 0x49, 0x36, 0x00 },
    ['4'] = { 0x18, 0x14, 0x12, 0x7F, 0x10, 0x00 },
    ['5'] = { 0x2F, 0x49, 0x49, 0x49, 0x31, 0x00 },
    ['6'] = { 0x3E, 0x49, 0x49, 0x49, 0x32, 0x00 },
    ['7'] = { 0x01, 0x71, 0x09, 0x05, 0x03, 0x00 },
    ['8'] = { 0x36, 0x49, 0x49, 0x49, 0x36, 0x00 },
    ['9'] = { 0x26, 0x49, 0x49, 0x49, 0x3E, 0x00 }
};

void init_led_screen(void) {
    i2c_write(LED_SCREEN_DEVICE_ID, (char *)oled_init_cmds, sizeof(oled_init_cmds));
}

void clear_screen(void) {
    char set_range[] = { 0x00, 0x21, 0x00, 0x7F, 0x22, 0x00, 0x07 };
    i2c_write(LED_SCREEN_DEVICE_ID, set_range, sizeof(set_range));

    char buffer[65];
    buffer[0] = 0x40;
    int i;
    for (i = 1; i < 65; i++) buffer[i] = 0x00;
    int page;
    for (page = 0; page < 8; page++) {
        i2c_write(LED_SCREEN_DEVICE_ID, buffer, sizeof(buffer));
        i2c_write(LED_SCREEN_DEVICE_ID, buffer, sizeof(buffer));
    }
}

void draw_string(int col, int page, const char *str) {
    char buffer[1 + 6 * 21];
    int i = 0;
    buffer[0] = 0x40;

    while (*str && i < 21) {
        int j;
        for (j = 0; j < 6; j++) {
            buffer[1 + i * 6 + j] = font6x8[(int)*str][j];
        }
        str++;
        i++;
    }

    char set_cursor[] = { 0x00, 0x21, col, 127, 0x22, page, page };
    i2c_write(LED_SCREEN_DEVICE_ID, set_cursor, sizeof(set_cursor));
    i2c_write(LED_SCREEN_DEVICE_ID, buffer, 1 + i * 6);
}

void display_start_game() {
    clear_screen();
    draw_string(0, 1, "     MINI TETRIS     ");
    draw_string(0, 4, "  CLICK JOYSTICK TO  ");
    draw_string(0, 5, "        START        ");
}

void display_game_over() {
    clear_screen();
    draw_string(0, 1, "     MINI TETRIS     ");
    draw_string(0, 4, "      GAME OVER      ");
}

void display_score(int score) {
    clear_screen();
    draw_string(0, 1, "     MINI TETRIS     ");
    draw_string(0, 4, "        SCORE        ");

    // Build the score string into a full 21-character buffer to avoid garbage
    char buffer[22]; // 21 characters + null terminator
    int j;
    for (j = 0; j < 21; j++) buffer[j] = ' ';  // Fill with spaces
    buffer[21] = '\0';

    // Format score as a right-aligned 3-digit number
    if (score >= 100) {
        buffer[9] = (score / 100) + '0';
        buffer[10] = ((score / 10) % 10) + '0';
        buffer[11] = (score % 10) + '0';
    } else if (score >= 10) {
        buffer[10] = ((score / 10) % 10) + '0';
        buffer[11] = (score % 10) + '0';
    } else {
        buffer[11] = (score % 10) + '0';
    }

    draw_string(0, 5, buffer);
}